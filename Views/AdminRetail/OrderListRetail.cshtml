@{
    ViewData["Title"] = "Danh Sách Đơn Hàng - Bán Lẻ";
    Layout = "~/Views/Shared/_AdminRetail.cshtml";
}

<!DOCTYPE html>
<html lang="vi" dir="ltr">



<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
          content="FamViệt - Hệ thống quản lý bán lẻ linh hoạt, mạnh mẽ, sạch sẽ & hiện đại với vô vàn tính năng hữu ích.">
    <meta name="keywords"
          content="mẫu quản trị, mẫu quản trị FamViệt, mẫu bảng điều khiển, mẫu quản trị phẳng, mẫu quản trị đáp ứng, ứng dụng web">
    <meta name="author" content="FamViệt Team">
    <link rel="icon" href="~/back-end/images/favicon.png" type="image/x-icon">
    <link rel="shortcut icon" href="~/back-end/images/favicon.png" type="image/x-icon">
    <title>FamViệt - Quản Lý Đơn Hàng Bán Lẻ</title>
    <!-- Google font-->
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">

    <!-- Fontawesome css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/font-awesome.css">

    <!-- Linear Icon css -->
    <link rel="stylesheet" href="~/back-end/css/linearicon.css">

    <!-- remixicon css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/remixicon.css">

    <!-- Data Table css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/datatables.css">

    <!-- Themify icon css-->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/themify.css">

    <!-- Feather icon css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/feather-icon.css">

    <!-- Plugins css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/scrollbar.css">
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/animate.css">

    <!-- Bootstrap css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/vendors/bootstrap.css">

    <!-- App css -->
    <link rel="stylesheet" type="text/css" href="~/back-end/css/style.css">
</head>
<body>
    <!-- tap on top start-->
    <div class="tap-top">
        <span class="lnr lnr-chevron-up"></span>
    </div>
    <!-- tap on tap end-->
    <!-- page-wrapper Start-->
    <div class="page-wrapper compact-wrapper" id="pageWrapper">
        <!-- Page Header Start-->
        <div class="page-header">
            <div class="header-wrapper m-0">
                <div class="header-logo-wrapper p-0">
                    <div class="logo-wrapper">
                        <a href="index.html">
                            <img class="img-fluid main-logo" src="assets/images/logo/1.png" alt="logo">
                            <img class="img-fluid white-logo" src="assets/images/logo/1-white.png" alt="logo">
                        </a>
                    </div>
                    <div class="toggle-sidebar">
                        <i class="status_toggle middle sidebar-toggle" data-feather="align-center"></i>
                        <a href="index.html">
                            <img src="assets/images/logo/1.png" class="img-fluid" alt="">
                        </a>
                    </div>
                </div>

                <form class="form-inline search-full" action="javascript:void(0)" method="get">
                    <div class="form-group w-100">
                        <div class="Typeahead Typeahead--twitterUsers">
                            <div class="u-posRelative">
                                <input class="demo-input Typeahead-input form-control-plaintext w-100" type="text"
                                       placeholder="Tìm kiếm FamViệt..." name="q" title="" autofocus>
                                <i class="close-search" data-feather="x"></i>
                                <div class="spinner-border Typeahead-spinner" role="status">
                                    <span class="sr-only">Đang tải...</span>
                                </div>
                            </div>
                            <div class="Typeahead-menu"></div>
                        </div>
                    </div>
                </form>
                
            </div>
        </div>
        <!-- Page Header Ends-->
        <!-- Page Body Start-->
        <div class="page-body-wrapper">
           
            <!-- Order section Start -->
            <div class="page-body">


                @* table for detail order start  *@
                <!-- Table Start -->
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card card-table">
                                <div class="card-body">
                                    <div class="title-header option-title d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">Danh Sách Đơn Hàng</h5>

                                        <input type="text" id="searchInput"
                                               placeholder="Tìm theo email..."
                                               class="form-control form-control-sm w-auto ms-3"
                                               style="width: 250px;" />
                                    </div>
                                
                                    <div>
                                        <div class="table-responsive mt-3">
                                            <table class="table table-bordered align-middle text-center" id="orderTable">
                                                <thead class="table-light">
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Ngày</th>
                                                        <th>Khách Hàng</th>
                                                        <th>Tổng</th>
                                                        <th>Tình Trạng</th>
                                                        <th>Lựa Chọn</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Table End -->
                <!-- footer start-->
                
            </div>
            <!-- Order section End -->
        </div>
        <!-- Page Body End-->
    </div>
    <!-- page-wrapper End -->
   
    

    
   
    <script src="assets/js/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap js -->
    <script src="assets/js/bootstrap/bootstrap.bundle.min.js"></script>

    <!-- feather icon js -->
    <script src="assets/js/icons/feather-icon/feather.min.js"></script>
    <script src="assets/js/icons/feather-icon/feather-icon.js"></script>

    <!-- customizer js -->
    <script src="assets/js/customizer.js"></script>

    <!-- scrollbar simplebar js -->
    <script src="assets/js/scrollbar/simplebar.js"></script>
    <script src="assets/js/scrollbar/custom.js"></script>

    <!-- Sidebar js -->
    <script src="assets/js/config.js"></script>

    <!-- Plugins js -->
    <script src="assets/js/sidebar-menu.js"></script>
    <script src="assets/js/notify/bootstrap-notify.min.js"></script>
    <script src="assets/js/notify/index.js"></script>

    <!-- Data table js -->
    <script src="assets/js/jquery.dataTables.js"></script>
    <script src="assets/js/custom-data-table.js"></script>

    <!-- all checkbox select js -->
    <script src="assets/js/checkbox-all-check.js"></script>

    <!-- sidebar effect -->
    <script src="assets/js/sidebareffect.js"></script>

    <!-- Theme js -->
    <script src="assets/js/script.js"></script>
</body>
@section Scripts {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />

    <script>
        let searching = false;

        async function loadOrders() {
            if (searching) return; // nếu đang search thì không cập nhật tự động

            const res = await fetch("/api/OrderRetailApi/pending-orders");
            const orders = await res.json();
            renderOrders(orders);
        }

        function renderOrders(orders) {
            const tbody = document.querySelector("#orderTable tbody");
            tbody.innerHTML = "";

            orders.forEach(order => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${order.id}</td>
                    <td>${new Date(order.orderDate).toLocaleDateString()}</td>
                    <td><a href="/AdminCustomer/Details/${order.customerEmail}">${order.customerEmail}</a></td>
                    <td>${order.totalAmount.toLocaleString()} đ</td>
                    <td>${order.status}</td>
                    <td class="text-nowrap">
                        <a href="#" class="text-success me-2 p-0 border-0 bg-transparent" title="Accept" onclick="confirmAccept(${order.id})">
                            <i class="fa fa-circle-check"></i>
                        </a>
                        <a href="#" class="text-danger me-2 p-0 border-0 bg-transparent" title="Cancel" onclick="confirmCancel(${order.id})">
                            <i class="fa fa-circle-xmark"></i>
                        </a>
                        <a href="/AdminRetail/OrderDetailRetail/${order.id}" class="text-info me-2" title="Chi tiết">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function confirmAccept(id) {
            if (confirm("Bạn có chắc muốn xác nhận đơn hàng này không?")) {
                await fetch(`/api/OrderRetailApi/accept/${id}`, { method: 'POST' });
                loadOrders();
            }
        }

        async function confirmCancel(id) {
            if (confirm("Bạn có chắc muốn hủy đơn hàng này không?")) {
                await fetch(`/api/OrderRetailApi/cancel/${id}`, { method: 'POST' });
                loadOrders();
            }
        }

        // Search động
        document.getElementById("searchInput").addEventListener("input", async function () {
            const keyword = this.value.trim();
            searching = keyword.length > 0;

            if (!searching) {
                loadOrders(); // nếu xóa input -> load lại bình thường
                return;
            }

            const response = await fetch(`/api/OrderRetailApi/searchbynamestatuspending?keyword=${encodeURIComponent(keyword)}`);
            const orders = await response.json();
            renderOrders(orders);
        });

        setInterval(loadOrders, 2000); // auto update nếu không search
        window.onload = loadOrders;
    </script>
}

</html>