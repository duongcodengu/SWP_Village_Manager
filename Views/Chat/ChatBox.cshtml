@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Chat";
    var isStaff = (bool)ViewBag.IsStaff;
    var receiverId = ViewBag.ReceiverId;
    var currentUserId = ViewBag.CurrentUserId;
}
<!DOCTYPE html>
<html lang="vi">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="FamViệt">
    <meta name="keywords" content="FamViệt">
    <meta name="author" content="FamViệt">
    <link rel="icon" href="~/images/favicon/1.png" type="image/x-icon">
    <title>Đăng nhập - FamViệt</title>

    <!-- Google font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Public+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- bootstrap css -->
    <link id="rtl-link" rel="stylesheet" type="text/css" href="~/css/vendors/bootstrap.css">

    <!-- Iconly css -->
    <link rel="stylesheet" type="text/css" href="~/css/bulk-style.css">

    <!-- Template css -->
    <link id="color-link" rel="stylesheet" type="text/css" href="~/css/style.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<link rel="stylesheet" href="~/css/chatbox.css" />

<div class="chat-container">
    @if (isStaff)
    {
        <div class="user-list">
            @foreach (var user in ViewBag.ChatUsers)
            {
                <div class="chat-user" onclick="selectUser(@user.Id)">
                    <img src="~/images/default-avatar.png" class="avatar" />
                    <span>@user.Username</span>
                    <span class="unread-count" id="unread-@user.Id"></span>
                </div>
            }
        </div>
    }

    <div class="chat-box">
        <div id="messages" class="message-list">
            <p>Đang tải tin nhắn...</p>
        </div>

        <div class="chat-input">
            <input type="text" id="messageInput" class="form-control" placeholder="Nhập tin nhắn..." />
            <button class="btn btn-primary" onclick="sendMessage()">Gửi</button>
        </div>
    </div>
</div>

<script>
    let receiverId = @receiverId;

    function selectUser(id) {
        receiverId = id;
        loadMessages();
    }

    function loadMessages() {
        fetch(`/Chat/LoadMessages?receiverId=${receiverId}`)
            .then(res => res.text())
            .then(html => {
                document.getElementById("messages").innerHTML = html;
            });
    }

    function sendMessage() {
        const message = document.getElementById("messageInput").value;
        if (!message.trim()) return;

        fetch('/Chat/sendmessage', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ receiverId, message })
        }).then(() => {
            document.getElementById("messageInput").value = '';
            loadMessages();
        });
    }

    function fetchUnreadCounts() {
        fetch('/Chat/getunreadcounts')
            .then(res => res.json())
            .then(data => {
                document.querySelectorAll('.unread-count').forEach(el => el.textContent = '');
                data.forEach(item => {
                    const el = document.getElementById('unread-' + item.senderId);
                    if (el) el.textContent = item.count > 0 ? `(${item.count})` : '';
                });
            });
    }

    setInterval(() => {
        if (receiverId) loadMessages();
        fetchUnreadCounts();
    }, 1000);

    window.onload = function () {
        loadMessages();
        fetchUnreadCounts();
    }
</script>
<script src="~/js/jquery-3.6.0.min.js"></script>

<!-- Bootstrap js-->
<script src="~/js/bootstrap/bootstrap.bundle.min.js"></script>
<script src="~/js/bootstrap/popper.min.js"></script>

<!-- feather icon js-->
<script src="~/js/feather/feather.min.js"></script>
<script src="~/js/feather/feather-icon.js"></script>

<!-- Slick js-->
<script src="~/js/slick/slick.js"></script>
<script src="~/js/slick/slick-animation.min.js"></script>
<script src="~/js/slick/custom_slick.js"></script>

<!-- Lazyload Js -->
<script src="~/js/lazysizes.min.js"></script>

<!-- script js -->
<script src="~/js/script.js"></script>

<!-- theme setting js -->
<script src="~/js/theme-setting.js"></script>
<style>
    .chat-container {
        display: flex;
        height: 500px;
        border: 1px solid #ccc;
    }

    .user-list {
        width: 250px;
        border-right: 1px solid #ccc;
        overflow-y: auto;
        padding: 10px;
        background: #f7f7f7;
    }

    .chat-user {
        display: flex;
        align-items: center;
        padding: 5px;
        cursor: pointer;
        position: relative;
    }

        .chat-user:hover {
            background-color: #eee;
        }

    .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    .unread-count {
        position: absolute;
        top: 5px;
        right: 10px;
        background: red;
        color: white;
        border-radius: 50%;
        padding: 2px 6px;
        font-size: 12px;
    }

    .chat-box {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 10px;
    }

    .message-list {
        overflow-y: auto;
        height: 400px;
        padding: 5px;
        background: #fff;
        border: 1px solid #ddd;
    }

    .message {
        margin-bottom: 10px;
    }

        .message.sent {
            text-align: right;
            color: blue;
        }

        .message.received {
            text-align: left;
            color: green;
        }

    .chat-input {
        display: flex;
        gap: 10px;
    }

</style>