@using Microsoft.AspNetCore.Http
@using Village_Manager.Extensions
@using Microsoft.EntityFrameworkCore
@using Village_Manager.Models
@using Village_Manager.Utils
@inject Village_Manager.Data.AppDbContext dbContext

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/Village_Manager.styles.css" asp-append-version="true" />
    <title>@ViewData["Title"] - FamViệt</title>

    <style>
        html.dark .fullpage-loader {
            background-color: #1e1e1e !important;
        }

        html.light .fullpage-loader {
            background-color: white !important;
        }
    </style>

</head>
<body>
    <style>
        .nav-link-new {
            display: block;
            padding: 12px 20px;
            margin: 4px 0;
            color: #333;
            font-weight: 500;
            background-color: #f8f9fa;
            border-radius: 8px;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
        }

            .nav-link-new:hover {
                background-color: #4CAF50;
                color: #fff;
                transform: translateX(5px);
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

        .nav-item:not(:last-child) {
            border-bottom: 1px solid #eaeaea;
        }

    </style>
    <!-- Header Start -->
    <header class="pb-md-4 pb-0">

        <div class="header-top">
            <div class="container-fluid-lg">
                <div class="row">
                    <div class="col-xxl-3 d-xxl-block d-none">
                        <div class="top-left-header">
                            <span class="text-white" style="white-space: nowrap";>Từ vườn đến bàn – Sạch từng hạt, ngon từng vị.</span>
                        </div>
                    </div>

                    <div class="col-xxl-6 col-lg-9 d-lg-block d-none">
                        <div class="header-offer">
                            <div class="notification-slider">
                                <div>
                                    <div class="timer-notification">
                                        <h6>
                                            <strong class="me-1">Chào mừng đến Fastkart!</strong>Nông sản thật – Chất lượng xanh cho cuộc sống lành.<strong class="ms-1">
                                            </strong>
                                        </h6>
                                    </div>
                                </div>

                                <div>
                                    <div class="timer-notification">
                                        <h6>
                                            Gửi trọn thiên nhiên – Trao trọn niềm tin.
                                            <a class="text-white">
                                                Mua ngay
                                                !
                                            </a>
                                        </h6>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <ul class="about-list right-nav-about">
                            <li class="right-nav-list">
                                <div class="dropdown theme-form-select">
                                    <img src="https://flagcdn.com/w40/vn.png" alt="Vietnam Flag" width="20" style="margin-right: 6px; vertical-align: middle;">
                                    <span>Việt Nam</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="top-nav top-header sticky-header">
            <div class="container-fluid-lg">
                <div class="row">
                    <div class="col-12">
                        <div class="navbar-top">        
                            <a href="/" class="web-logo nav-logo">
                                <img src="~/images/logo/logo.png" class="img-fluid blur-up lazyload" alt="">
                            </a>

                            <div class="middle-box">
                                <form method="get" asp-controller="Shop" asp-action="Search" class="search-box">
                                    <div class="input-group">
                                        <input type="text" name="search" class="form-control" placeholder="Tìm kiếm sản phẩm" />
                                        <button class="btn" type="submit"> <i data-feather="search"></i> </button>
                                    </div>
                                </form>
                            </div>

                            <div class="rightside-box">
                                <form method="get" asp-controller="Shop" asp-action="Search" class="search-full">
                                    <div class="input-group">
                                        <span class="input-group-text"> <i data-feather="search" class="font-light"></i> </span>
                                        <input type="text" name="search" class="form-control search-type" placeholder="Tìm kiếm sản phẩm" />
                                        <button class="input-group-text" type="submit"> <i data-feather="arrow-right" class="font-light"></i> </button>
                                        <span class="input-group-text close-search"> <i data-feather="x" class="font-light"></i> </span>
                                    </div>
                                </form>

                                <ul class="right-side-menu">
                                    <li class="right-side">
                                        <div class="delivery-login-box">
                                            <div class="delivery-icon" style="cursor: pointer;">
                                                <div class="search-box">
                                                    <i data-feather="search"></i>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="right-side">
                                        <a href="/contact-us" class="delivery-login-box">
                                            <div class="delivery-icon" style="cursor: pointer;">
                                                <i data-feather="phone-call"></i>
                                            </div>
                                            <div class="delivery-detail">
                                                <h6>Hỗ trợ 24/7</h6>
                                                <h5>+84 123456789</h5>
                                            </div>
                                        </a>
                                    </li>
                                    <li class="right-side">
                                        <div class="onhover-dropdown header-badge">
                                            <button type="button" class="btn p-0 position-relative header-wishlist">
                                                <i data-feather="shopping-cart"></i>
                                                <span class="position-absolute top-0 start-100 translate-middle badge">
                                                    @Village_Manager.Utils.CartHelper.GetCartCount(Context)
                                                </span>
                                            </button>

                                            @{
                                                var cartItems = CartHelper.GetCartWithProducts(Context, dbContext);
                                                var total = cartItems.Sum(i => (i.Product?.Price ?? 0) * i.Quantity);
                                            }

                                            <div class="onhover-div">

                                                <ul class="cart-list">
                                                    @if (cartItems.Count > 0)
                                                    {
                                                        foreach (var item in cartItems)
                                                        {
                                                            <li class="product-box-contain">
                                                                <div class="drop-cart d-flex">
                                                                    <a href="/shop/detail/@item.ProductId" class="drop-image">
                                                                        <img src="@(item.Product?.ProductImages?.FirstOrDefault()?.ImageUrl ?? "/images/product/default-product.png")"
                                                                             class="blur-up lazyloaded" alt="@item.Product?.Name" />
                                                                    </a>

                                                                    <div class="drop-contain w-100">
                                                                        <div class="d-flex justify-content-between align-items-start w-100">
                                                                            <div class="flex-grow-1 me-3">
                                                                                <a href="/shop/detail/@item.ProductId" class="text-decoration-none text-dark">
                                                                                    <h5 class="mb-1">@item.Product?.Name</h5>
                                                                                </a>
                                                                                <h6 class="mb-0"><span>@item.Quantity x</span> ₫@String.Format("{0:N0}", item.Product?.Price)</h6>
                                                                            </div>

                                                                            <div style="flex-shrink: 0;">
                                                                                <a href="/shop/removefromcart/@item.ProductId" class="text-dark">
                                                                                    <i class="fa-solid fa-xmark"></i>
                                                                                </a>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        }
                                                    }
                                                    else
                                                    {
                                                        <li class="text-center p-2">Giỏ hàng của bạn trống.</li>
                                                    }
                                                </ul>

                                                <div class="price-box">
                                                    <h5>Tổng :</h5>
                                                    <h4 class="theme-color fw-bold">₫@String.Format("{0:N0}", total)</h4>
                                                </div>

                                                @if (Context.Session.GetInt32("UserId") != null)
                                                {
                                                    <div class="button-group">
                                                        <a href="/shop/cart" class="btn btn-sm cart-button">Xem giỏ hàng</a>
                                                        <a href="/shop/checkout" class="btn btn-sm cart-button theme-bg-color
                                                        text-white">Thanh toán</a>
                                                    </div>
                                                } else
                                                {
                                                    <div class="button-group">
                                                        <a href="/shop/cart" class="btn btn-sm cart-button">Xem giỏ hàng</a>
                                                        <a href="/login" class="btn btn-sm cart-button theme-bg-color
                                                            text-white">Đăng nhập</a>
                                                    </div>
                                                }
                                            </div>
                                        </div>
                                    </li>

                                    @* hien thi session khi login *@
                                    @{
                                        // lay session tu context
                                        var username = Context.Session.GetString("Username");
                                        var roleId = Context.Session.GetInt32("RoleId");
                                    }
                                    <li class="right-side onhover-dropdown">
                                        <div class="delivery-login-box">
                                            <div class="delivery-icon" style="cursor: pointer;">
                                                <i data-feather="user"></i>
                                            </div>
                                            <div class="delivery-detail">
                                                <h6>Xin chào,</h6>
                                                <h5>
                                                    @(string.IsNullOrEmpty(username) ? "Đăng nhập / Đăng ký" : username)
                                                </h5>
                                            </div>
                                        </div>

                                        @if (string.IsNullOrEmpty(username))
                                        {
                                            <div class="onhover-div onhover-div-login">
                                                <ul class="user-box-name">
                                                    <li class="product-box-contain">
                                                        <a href="/login">Đăng nhập</a>
                                                    </li>
                                                    <li class="product-box-contain">
                                                        <a href="signup">Đăng ký</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="onhover-div onhover-div-login">
                                                <ul class="user-box-name">
                                                    @* neu role la 1 thi la admin *@
                                                    @if (roleId == 1)
                                                    {
                                                        <li class="product-box-contain">
                                                            <a href="/adminwarehouse">Quản lý của Admin</a>
                                                        </li>
                                                    }
                                                    @if (roleId == 2)
                                                    {
                                                        <li class="product-box-contain">
                                                            <a href="/adminretail">Quản lý của nhân viên</a>
                                                        </li>
                                                    }
                                                    @* rold nao cung co *@
                                                    <li class="product-box-contain">
                                                        <a href="/customer">Thông tin tài khoản</a>
                                                    </li>
                                                    <li class="product-box-contain">
                                                        <a href="/logout">Đăng xuất</a>
                                                    </li>
                                                    <li class="product-box-contain">
                                                        <a href="/changepassword">Đổi mật khẩu</a>
                                                    </li>
                                                    <li class="product-box-contain">
                                                        <a href="/chatbox">Chatbox</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        }
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container-fluid-lg">
            <div class="row">
                <div class="col-12">
                    <div class="header-nav">
                        <div class="header-nav-left">
                            <button class="dropdown-category">
                                <i data-feather="align-left"></i>
                                <span>Danh Mục</span>
                            </button>

                            <div class="category-dropdown">
                                <div class="category-title">
                                    <h5>Danh mục</h5>
                                    <button type="button" class="btn p-0 close-button text-content">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </div>

                                <ul class="navbar-nav">
                                    @* ai cũng có *@
                                    <li class="nav-item dropdown">
                                        <a class="nav-link-new" href="/shop/search">Tất cả sản phẩm</a>
                                    </li>
                                    @if (Context.Session.GetInt32("RoleId") == 3)
                                    {
                                        <li class="nav-item">
                                            <a class="nav-link-new" href="/becomefamer">Đăng ký Famer</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link-new" href="/shipperbecome">Đăng ký Shipper</a>
                                        </li>
                                    }
                                    else if (Context.Session.GetInt32("RoleId") == 5)
                                    {
                                        <li class="nav-item">
                                            <a class="nav-link-new" href="/dashboardfamer">Famer Dashboard</a>
                                        </li>
                                    }
                                    else if (Context.Session.GetInt32("RoleId") == 4)
                                    {
                                        <li class="nav-item">
                                            <a class="nav-link-new" href="/dashboardshipper">Shipper Dashboard</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        </div>

                        <div class="header-nav-middle">
                            <div class="main-nav navbar navbar-expand-xl navbar-light navbar-sticky">
                                <div class="offcanvas offcanvas-collapse order-xl-2" id="primaryMenu">
                                    <div class="offcanvas-header navbar-shadow">
                                        <h5>Menu</h5>
                                        <button class="btn-close lead" type="button"
                                                data-bs-dismiss="offcanvas"></button>
                                    </div>
                                    <div class="offcanvas-body">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* sau nay làm thông báo *@
                        <div class="header-nav-right dropdown">
                            <button class="btn notification-button position-relative" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i data-feather="bell"></i>
                                <span>Thông báo</span>
                                <span id="notif-badge" class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">
                                    0
                                </span>
                            </button>

                            <ul class="dropdown-menu dropdown-menu-end p-3 shadow-lg" style="width: 320px; max-height: 400px; overflow-y: auto;" id="notif-dropdown">
                                <li class="text-center text-muted">Không có thông báo</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Header End -->
    <!-- mobile fix menu start -->
    <div class="fullpage-loader">
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
        <span></span>
    </div>
    <div class="mobile-menu d-md-none d-block mobile-cart">
        <ul>
            <li>
                <a href="/">
                    <i class="iconly-Home icli"></i>
                    <span>Trang chủ</span>
                </a>
            </li>

            <li class="mobile-category">
                <a href="javascript:void(0)">
                    <i class="iconly-Category icli js-link"></i>
                    <span>Danh mục</span>
                </a>
            </li>

            <li>
                <a href="/shop/search" class="search-box">
                    <i class="iconly-Search icli"></i>
                    <span>Tìm kiếm</span>
                </a>
            </li>
            <li>
                <a href="/shop/cart">
                    <i class="iconly-Bag-2 icli fly-cate"></i>
                    <span>Giỏ hàng</span>
                </a>
            </li>
        </ul>
    </div>
    <!-- mobile fix menu end -->

    <div class="container-fluid">
        <main role="main" class="pb-6">
            @RenderBody()
        </main>
    </div>

    <!-- Footer Section Start -->
    <footer class="section-t-space">
        <div class="container-fluid-lg">
            <div class="service-section">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="service-contain">
                            <div class="service-box">
                                <div class="service-image">
                                    <img src="~/svg/product.svg" class="blur-up lazyload" alt="">
                                </div>

                                <div class="service-detail">
                                    <h5>Sản phảm tươi</h5>
                                </div>
                            </div>

                            <div class="service-box">
                                <div class="service-image">
                                    <img src="~/svg/delivery.svg" class="blur-up lazyload" alt="">
                                </div>

                                <div class="service-detail">
                                    <h5>Giao hàng miễn phí</h5>
                                </div>
                            </div>

                            <div class="service-box">
                                <div class="service-image">
                                    <img src="~/svg/discount.svg" class="blur-up lazyload" alt="">
                                </div>

                                <div class="service-detail">
                                    <h5>Giảm giá mỗi ngày</h5>
                                </div>
                            </div>

                            <div class="service-box">
                                <div class="service-image">
                                    <img src="~/svg/market.svg" class="blur-up lazyload" alt="">
                                </div>

                                <div class="service-detail">
                                    <h5>Giá tốt nhất trên thị trường</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="main-footer section-b-space section-t-space">
                <div class="container">
                    <div class="row g-md-4 g-3 justify-content-center">
                        <div class="col-lg-6 col-md-8">
                            <div class="footer-logo">
                                <div class="theme-logo">
                                    <a href="/">
                                        <img src="~/images/logo/logo.png" class="blur-up lazyload" alt="FamViệt">
                                    </a>
                                </div>
                                <div class="footer-logo-contain">
                                    <p>
                                        FamViệt là nền tảng bán lẻ nông sản trực tuyến, cung cấp đa dạng rau củ, trái cây, thịt cá và thực phẩm đông lạnh. Chúng tôi cam kết mang đến sản phẩm chất lượng, giá cả hợp lý và giao hàng tận nơi nhanh chóng.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4 col-md-6">
                            <div class="footer-title">
                                <h4>Liên hệ - 24/7</h4>
                            </div>

                            <div class="footer-contact">
                                <ul>
                                    <li>
                                        <div class="footer-number">
                                            <i data-feather="phone"></i>
                                            <div class="contact-number">
                                                <h6 class="text-content">Di động</h6>
                                                <h5>+84 123456789</h5>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="footer-number">
                                            <i data-feather="mail"></i>
                                            <div class="contact-number">
                                                <h6 class="text-content">Email:</h6>
                                                <h5>famviet@sonlam1204.com</h5>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="footer-number">
                                            <i data-feather="map-pin"></i>
                                            <div class="contact-number">
                                                <h6 class="text-content">Địa chỉ:</h6>
                                                <h5>Hà Nội</h5>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sub-footer section-small-space d-flex justify-content-center">
                <div class="reserve">
                    <h6 class="text-content">©2025 FamViệt. Đã đăng ký bản quyền.</h6>
                </div>
            </div>
        </div>
    </footer>
    <!-- Footer Section End -->
    @RenderSection("Scripts", required: false)

    @* model thông báo  *@
    <div class="modal fade" id="allNotificationsModal" tabindex="-1" aria-labelledby="allNotificationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allNotificationsModalLabel">Tất cả thông báo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body" id="all-notifications-list">
                    <!-- Danh sách thông báo sẽ render ở đây -->
                </div>
            </div>
        </div>
    </div>

    <style>
        .notification-item {
            font-size: 0.9rem;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

            .notification-item span {
                flex-grow: 1;
                margin-right: 0.5rem;
            }

        .notification-time {
            font-size: 0.75rem;
            color: gray;
            display: block;
        }

        .mark-read {
            font-size: 0.8rem;
        }

        .list-group-item.unread {
            background-color: #f8f9fa;
        }
    </style>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            function loadNotifications() {
                fetch("/api/notificationapi/all-unread")
                    .then(res => {
                        if (!res.ok) throw new Error("Lỗi API");
                        return res.json();
                    })
                    .then(data => {
                        const badge = document.getElementById("notif-badge");
                        const dropdown = document.getElementById("notif-dropdown");

                        badge.textContent = data.unreadCount ?? 0;

                        // Render header + nút
                        dropdown.innerHTML = `
                            <li>
                                <i class="ri-notification-line"></i>
                                <h6 class="f-18 mb-0">Thông báo</h6>
                                <div class="d-flex gap-2 mt-2">
                                    <button class="btn btn-sm btn-outline-danger notif-red-btn" id="notif-readall-btn">Đọc tất cả</button>
                                    <button class="btn btn-sm btn-outline-warning notif-yellow-btn" id="notif-showall-btn">Xem tất cả</button>
                                </div>
                            </li>
                        `;

                        if (!data.notifications || data.notifications.length === 0) {
                            dropdown.innerHTML += `<li><p class="text-center text-muted">Không có thông báo nào.</p></li>`;
                        } else {
                            data.notifications.forEach(n => {
                                dropdown.innerHTML += `
                                    <li>
                                        <p class="notif-item${n.is_read ? ' text-muted' : ' fw-bold'}"
                                            data-id="${n.id}" style="cursor:pointer;">
                                            <i class="fa fa-circle me-2 font-info"></i>
                                            ${n.content}
                                        </p>
                                    </li>`;
                            });
                        }

                        // Gán sự kiện cho từng thông báo
                        dropdown.querySelectorAll('.notif-item').forEach(item => {
                            item.addEventListener('click', function () {
                                const notifId = this.getAttribute('data-id');
                                fetch(`/api/notificationapi/read/${notifId}`, { method: 'POST' })
                                    .then(() => {
                                        this.classList.remove('fw-bold');
                                        this.classList.add('text-muted');
                                        loadNotifications(); // reload lại để cập nhật badge
                                    });
                            });
                        });

                        // Gán sự kiện cho nút Đọc tất cả
                        const readAllBtn = document.getElementById('notif-readall-btn');
                        if (readAllBtn) {
                            readAllBtn.onclick = function () {
                                fetch('/api/notificationapi/readall', { method: 'POST' })
                                    .then(() => loadNotifications());
                            };
                        }
                    })
                    .catch(error => {
                        console.error("Lỗi khi tải thông báo:", error);
                        document.getElementById("notif-dropdown").innerHTML += `
                            <li><p class="text-center text-danger"></p></li>`;
                    });
            }

            loadNotifications();
            // tự động reload thông báo mỗi 30 giây:
            setInterval(loadNotifications, 30000);
        });
    </script>
    <script>
        // Sự kiện cho nút "Xem tất cả"
        document.addEventListener("click", function (e) {
            if (e.target && e.target.id === "notif-showall-btn") {
                fetch("/api/notificationapi/all?all=true")
                    .then(res => res.json())
                    .then(data => {
                        const list = document.getElementById("all-notifications-list");
                        if (!data.notifications || data.notifications.length === 0) {
                            list.innerHTML = `<p class="text-center text-muted">Không có thông báo nào.</p>`;
                        } else {
                            let html = '<ul class="list-group">';
                            data.notifications.forEach(n => {
                                const time = new Date(n.created_at).toLocaleString("vi-VN");
                                html += `
                                    <li class="list-group-item${n.is_read ? ' text-muted' : ' fw-bold'}">
                                        <i class="fa fa-circle me-2 font-info"></i>
                                        ${n.content}
                                    </li>`;
                            });
                            html += '</ul>';
                            list.innerHTML = html;
                        }
                        // Hiện modal
                        $('#allNotificationsModal').modal('show');
                    });
            }
        });
    </script>
    <style>
        .notif-red-btn {
            border-color: #dc3545 !important;
            color: #dc3545 !important;
            background: #fff !important;
        }

            .notif-red-btn:hover, .notif-red-btn:focus {
                background: #dc3545 !important;
                color: #fff !important;
                border-color: #dc3545 !important;
            }

        .notif-yellow-btn {
            border-color: #ffc107 !important;
            color: #ffc107 !important;
            background: #fff !important;
        }

            .notif-yellow-btn:hover, .notif-yellow-btn:focus {
                background: #ffc107 !important;
                color: #fff !important;
                border-color: #ffc107 !important;
            }
    </style>

</body>
</html>
